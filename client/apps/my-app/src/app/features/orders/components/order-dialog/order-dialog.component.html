<div class="order-dialog">
  <h2 mat-dialog-title class="dialog-title">
    <ax-icon [name]="isEdit ? 'edit' : 'add_circle'" class="title-icon"></ax-icon>
    {{ isEdit ? ('editOrder' | translate) : ('addOrder' | translate) }}
  </h2>

  <form [formGroup]="orderForm" (ngSubmit)="onSubmit()">
    <mat-dialog-content class="dialog-content">
      <!-- Customer Selection -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field full-width">
          <mat-label>{{ 'customer' | translate }}</mat-label>
          <mat-select formControlName="customerId" (selectionChange)="onCustomerChange($event.value)">
            <mat-option [value]="''">{{ 'selectCustomer' | translate }}</mat-option>
            @for (customer of customers(); track customer.id) {
              <mat-option [value]="customer.id">
                {{ customer.companyName || (customer.firstName + ' ' + customer.lastName) }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Order Items Section -->
      <div class="items-section">
        <h3 class="section-title">{{ 'orderItems' | translate }}</h3>

        <!-- Product Selection -->
        <div class="product-selection">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ 'product' | translate }}</mat-label>
            <mat-select [value]="selectedProduct()" (selectionChange)="selectedProduct.set($event.value)">
              <mat-option [value]="null">{{ 'selectProduct' | translate }}</mat-option>
              @for (product of products(); track product.id) {
                <mat-option [value]="product.id">
                  {{ product.productName || product.productCode }} - ${{ product.unitPrice?.toFixed(2) || '0.00' }}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field quantity-field">
            <mat-label>{{ 'quantity' | translate }}</mat-label>
            <input matInput type="number" [value]="quantity()" (input)="quantity.set(+$any($event.target).value)"
                   min="1" step="1">
          </mat-form-field>

          <ax-button
                  variant="raised"
                  color="primary"
                  type="button"
                  [label]="'add' | translate"
                  (click)="onAddProduct()"
                  [disabled]="!selectedProduct() || loading()">
          </ax-button>
        </div>

        <!-- Items Table -->
        <div class="items-table-container">
          <table mat-table [dataSource]="currentOrder()?.items || []" class="items-table">
            <ng-container matColumnDef="product">
              <th mat-header-cell *matHeaderCellDef>{{ 'product' | translate }}</th>
              <td mat-cell *matCellDef="let item">{{ item.productName || item.productCode }}</td>
            </ng-container>

            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>{{ 'quantity' | translate }}</th>
              <td mat-cell *matCellDef="let item">
                <div class="quantity-controls">
                  <ax-button
                          variant="icon"
                          type="button"
                          (click)="onUpdateQuantity(item.id!, (item.quantity || 1) - 1)"
                          [disabled]="loading() || (item.quantity || 1) <= 1"
                          class="quantity-button">
                    <ax-icon name="remove"></ax-icon>
                  </ax-button>
                  <span class="quantity-value">{{ item.quantity || 0 }}</span>
                  <ax-button
                          variant="icon"
                          type="button"
                          (click)="onUpdateQuantity(item.id!, (item.quantity || 1) + 1)"
                          [disabled]="loading()"
                          class="quantity-button">
                    <ax-icon name="add"></ax-icon>
                  </ax-button>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="unitPrice">
              <th mat-header-cell *matHeaderCellDef class="text-right">{{ 'unitPrice' | translate }}</th>
              <td mat-cell *matCellDef="let item" class="text-right">${{ item.unitPrice?.toFixed(2) || '0.00' }}</td>
            </ng-container>

            <ng-container matColumnDef="lineTotal">
              <th mat-header-cell *matHeaderCellDef class="text-right">{{ 'lineTotal' | translate }}</th>
              <td mat-cell *matCellDef="let item" class="text-right">${{ item.lineTotal?.toFixed(2) || '0.00' }}</td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="text-center">{{ 'actions' | translate }}</th>
              <td mat-cell *matCellDef="let item" class="text-center">
                <ax-button
                        variant="icon"
                        color="warn"
                        type="button"
                        (click)="onRemoveItem(item.id!)"
                        [disabled]="loading()"
                        class="remove-button">
                  <ax-icon name="delete"></ax-icon>
                </ax-button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>

          @if (!currentOrder()?.items || currentOrder()?.items?.length === 0) {
            <div class="no-items">
              <p>{{ 'noOrderItems' | translate }}</p>
            </div>
          }
        </div>
      </div>

      <!-- Order Details -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'status' | translate }}</mat-label>
          <mat-select formControlName="status">
            <mat-option value="DRAFT">{{ 'order.status.draft' | translate }}</mat-option>
            <mat-option value="PENDING_APPROVAL">{{ 'order.status.pendingApproval' | translate }}</mat-option>
            <mat-option value="APPROVED">{{ 'order.status.approved' | translate }}</mat-option>
            <mat-option value="SHIPPING_INSTRUCTED">{{ 'order.status.shippingInstructed' | translate }}</mat-option>
            <mat-option value="SHIPPED">{{ 'order.status.shipped' | translate }}</mat-option>
            <mat-option value="INVOICED">{{ 'order.status.invoiced' | translate }}</mat-option>
            <mat-option value="PAID">{{ 'order.status.paid' | translate }}</mat-option>
            <mat-option value="CANCELLED">{{ 'order.status.cancelled' | translate }}</mat-option>
            <mat-option value="PENDING">{{ 'order.status.pending' | translate }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'orderDate' | translate }}</mat-label>
          <input matInput [matDatepicker]="orderDatePicker" formControlName="orderDate">
          <mat-datepicker-toggle matIconSuffix [for]="orderDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #orderDatePicker></mat-datepicker>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'shipDate' | translate }}</mat-label>
          <input matInput [matDatepicker]="shipDatePicker" formControlName="shipDate">
          <mat-datepicker-toggle matIconSuffix [for]="shipDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #shipDatePicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'invoiceNumber' | translate }}</mat-label>
          <input matInput formControlName="invoiceNumber">
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'invoiceDate' | translate }}</mat-label>
          <input matInput [matDatepicker]="invoiceDatePicker" formControlName="invoiceDate">
          <mat-datepicker-toggle matIconSuffix [for]="invoiceDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #invoiceDatePicker></mat-datepicker>
        </mat-form-field>
      </div>

      <!-- Addresses -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'shippingAddress' | translate }}</mat-label>
          <mat-select formControlName="shippingAddressId">
            <mat-option [value]="''">{{ 'selectAddress' | translate }}</mat-option>
            @for (address of addresses(); track address.id) {
              <mat-option [value]="address.id">
                {{ address.streetAddress1 }}, {{ address.city }}, {{ address.state }} {{ address.postalCode }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'billingAddress' | translate }}</mat-label>
          <mat-select formControlName="billingAddressId">
            <mat-option [value]="''">{{ 'selectAddress' | translate }}</mat-option>
            @for (address of addresses(); track address.id) {
              <mat-option [value]="address.id">
                {{ address.streetAddress1 }}, {{ address.city }}, {{ address.state }} {{ address.postalCode }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Totals -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'subtotal' | translate }}</mat-label>
          <input matInput type="number" formControlName="subtotal" step="0.01" readonly>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'tax' | translate }}</mat-label>
          <input matInput type="number" formControlName="tax" step="0.01">
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'shippingCost' | translate }}</mat-label>
          <input matInput type="number" formControlName="shippingCost" step="0.01">
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'total' | translate }}</mat-label>
          <input matInput type="number" formControlName="total" step="0.01" readonly>
        </mat-form-field>
      </div>

      <!-- Notes -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field full-width">
          <mat-label>{{ 'notes' | translate }}</mat-label>
          <textarea matInput formControlName="notes" rows="3"></textarea>
        </mat-form-field>
      </div>

      <!-- JSON Data (optional) -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field full-width">
          <mat-label>{{ 'jsonData' | translate }}</mat-label>
          <textarea
                  matInput
                  formControlName="jsonData"
                  rows="4"
                  [class.is-invalid]="isFieldInvalid('jsonData')"></textarea>
          <mat-hint>{{ 'jsonDataHint' | translate }}</mat-hint>
          @if (isFieldInvalid('jsonData')) {
            <mat-error>
              {{ getErrorMessage('jsonData') }}
            </mat-error>
          }
        </mat-form-field>
      </div>
    </mat-dialog-content>

    <mat-dialog-actions align="end" class="dialog-actions">
      <ax-button
              variant="stroked"
              type="button"
              [label]="'cancel' | translate"
              (click)="onCancel()">
      </ax-button>
      <ax-button
              variant="raised"
              color="primary"
              type="submit"
              [label]="isEdit ? ('update' | translate) : ('add' | translate)"
              [disabled]="orderForm.invalid || loading()">
      </ax-button>
    </mat-dialog-actions>
  </form>
</div>
