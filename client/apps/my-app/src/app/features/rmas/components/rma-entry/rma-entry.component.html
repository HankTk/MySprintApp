<div class="rma-entry-container">
  <mat-card class="main-card">
    <mat-card-header>
      <div class="header-content">
        <button mat-icon-button (click)="goBack()" aria-label="Go back" class="back-button">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <mat-card-title class="card-title">
          <mat-icon class="title-icon">assignment_return</mat-icon>
          {{ 'rmaEntry.title' | translate }}
        </mat-card-title>
      </div>
    </mat-card-header>

    <mat-card-content>
      @if (loading()) {
        <div class="loading-container">
          <ax-progress type="spinner" mode="indeterminate"></ax-progress>
        </div>
      } @else {
        <!-- Step Indicator -->
        <div class="step-indicator">
          <div class="step-list">
            @for (step of steps; track step.key) {
              <div
                      class="step-item"
                      [class.active]="currentStep() === step.key"
                      [class.completed]="isStepCompleted(step.key)"
                      [class.clickable]="isStepCompleted(step.key) || currentStep() === step.key"
                      (click)="onStepClick(step.key)">
                <div class="step-number">{{ $index + 1 }}</div>
                <div class="step-label">{{ step.label | translate }}</div>
              </div>
            }
          </div>
        </div>

        <!-- Entry Step with Sub-steps -->
        @if (currentStep() === 'entry') {
          <div class="entry-sub-steps">
            <div class="sub-step-indicator">
              @for (subStep of entrySubSteps; track subStep.key) {
                <button
                        mat-button
                        class="sub-step-button"
                        [class.active]="currentEntrySubStep() === subStep.key"
                        [class.completed]="isSubStepCompleted(subStep.key)"
                        (click)="currentEntrySubStep.set(subStep.key)">
                  {{ subStep.label | translate }}
                </button>
              }
            </div>

            <div class="step-content">
              <!-- Order Sub-step -->
              @if (currentEntrySubStep() === 'order') {
                <div class="sub-step-content">
                  <h3>{{ 'rmaEntry.subStep.order' | translate }}</h3>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>{{ 'order' | translate }}</mat-label>
                    <mat-select [value]="rma()?.orderId || null" (selectionChange)="onOrderChange($event.value)">
                      <mat-option [value]="null">{{ 'selectOrder' | translate }}</mat-option>
                      @for (order of orders(); track order.id) {
                        <mat-option [value]="order.id">
                          {{ order.orderNumber || order.id }} - {{ getCustomerName(order.customerId) }}
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                  @if (rma()?.customerName) {
                    <p><strong>{{ 'customer' | translate }}:</strong> {{ rma()?.customerName }}</p>
                  }
                </div>
              }

              <!-- Products Sub-step -->
              @if (currentEntrySubStep() === 'products') {
                <div class="sub-step-content">
                  <h3>{{ 'rmaEntry.subStep.products' | translate }}</h3>

                  <div class="product-selection">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>{{ 'product' | translate }}</mat-label>
                      <mat-select [value]="selectedProduct()" (selectionChange)="selectedProduct.set($event.value)">
                        <mat-option [value]="null">{{ 'selectProduct' | translate }}</mat-option>
                        @for (product of products(); track product.id) {
                          <mat-option [value]="product.id">
                            {{ product.productName || product.productCode }} -
                            ${{ product.unitPrice?.toFixed(2) || '0.00' }}
                          </mat-option>
                        }
                      </mat-select>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field quantity-field">
                      <mat-label>{{ 'quantity' | translate }}</mat-label>
                      <input matInput type="number" [value]="quantity()"
                             (input)="quantity.set(+$any($event.target).value)" min="1" step="1">
                    </mat-form-field>

                    <ax-button
                            variant="raised"
                            color="primary"
                            [label]="'add' | translate"
                            (click)="onAddProduct()"
                            [disabled]="!selectedProduct() || loading()">
                    </ax-button>
                  </div>

                  <div class="items-table-container">
                    <table mat-table [dataSource]="rma()?.items || []" class="items-table">
                      <ng-container matColumnDef="product">
                        <th mat-header-cell *matHeaderCellDef>{{ 'product' | translate }}</th>
                        <td mat-cell *matCellDef="let item">{{ item.productName || item.productCode }}</td>
                      </ng-container>

                      <ng-container matColumnDef="quantity">
                        <th mat-header-cell *matHeaderCellDef>{{ 'quantity' | translate }}</th>
                        <td mat-cell *matCellDef="let item">
                          <div class="quantity-controls">
                            <button
                                    mat-icon-button
                                    (click)="onUpdateQuantity(item.id!, (item.quantity || 1) - 1)"
                                    [disabled]="loading() || (item.quantity || 1) <= 1"
                                    class="quantity-button">
                              <mat-icon>remove</mat-icon>
                            </button>
                            <span class="quantity-value">{{ item.quantity || 0 }}</span>
                            <button
                                    mat-icon-button
                                    (click)="onUpdateQuantity(item.id!, (item.quantity || 1) + 1)"
                                    [disabled]="loading()"
                                    class="quantity-button">
                              <mat-icon>add</mat-icon>
                            </button>
                          </div>
                        </td>
                      </ng-container>

                      <ng-container matColumnDef="returnedQuantity">
                        <th mat-header-cell *matHeaderCellDef>{{ 'returnedQuantity' | translate }}</th>
                        <td mat-cell *matCellDef="let item">
                          <div class="quantity-controls">
                            <button
                                    mat-icon-button
                                    (click)="onUpdateReturnedQuantity(item.id!, (item.returnedQuantity || 0) - 1)"
                                    [disabled]="loading() || (item.returnedQuantity || 0) <= 0"
                                    class="quantity-button">
                              <mat-icon>remove</mat-icon>
                            </button>
                            <span class="quantity-value">{{ item.returnedQuantity || 0 }}</span>
                            <button
                                    mat-icon-button
                                    (click)="onUpdateReturnedQuantity(item.id!, (item.returnedQuantity || 0) + 1)"
                                    [disabled]="loading() || (item.returnedQuantity || 0) >= (item.quantity || 0)"
                                    class="quantity-button">
                              <mat-icon>add</mat-icon>
                            </button>
                          </div>
                        </td>
                      </ng-container>

                      <ng-container matColumnDef="unitPrice">
                        <th mat-header-cell *matHeaderCellDef class="text-right">{{ 'unitPrice' | translate }}</th>
                        <td mat-cell *matCellDef="let item" class="text-right">
                          ${{ item.unitPrice?.toFixed(2) || '0.00' }}
                        </td>
                      </ng-container>

                      <ng-container matColumnDef="lineTotal">
                        <th mat-header-cell *matHeaderCellDef class="text-right">{{ 'lineTotal' | translate }}</th>
                        <td mat-cell *matCellDef="let item" class="text-right">
                          ${{ item.lineTotal?.toFixed(2) || '0.00' }}
                        </td>
                      </ng-container>

                      <ng-container matColumnDef="reason">
                        <th mat-header-cell *matHeaderCellDef>{{ 'reason' | translate }}</th>
                        <td mat-cell *matCellDef="let item">
                          <input
                                  matInput
                                  [value]="item.reason || ''"
                                  (blur)="onUpdateReason(item.id!, $any($event.target).value)"
                                  placeholder="{{ 'returnReason' | translate }}">
                        </td>
                      </ng-container>

                      <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef class="text-center">{{ 'actions' | translate }}</th>
                        <td mat-cell *matCellDef="let item" class="text-center">
                          <button
                                  mat-icon-button
                                  color="warn"
                                  (click)="onRemoveItem(item.id!)"
                                  [disabled]="loading()"
                                  class="remove-button">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </td>
                      </ng-container>

                      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                    </table>

                    @if (!rma()?.items || rma()?.items?.length === 0) {
                      <div class="no-items">
                        <p>{{ 'noOrderItems' | translate }}</p>
                      </div>
                    }
                  </div>
                </div>
              }

              <!-- Reason Sub-step -->
              @if (currentEntrySubStep() === 'reason') {
                <div class="sub-step-content">
                  <h3>{{ 'rmaEntry.subStep.reason' | translate }}</h3>
                  <p>{{ 'rmaEntry.reason.description' | translate }}</p>
                  <div class="items-table-container">
                    <table mat-table [dataSource]="rma()?.items || []" class="items-table">
                      <ng-container matColumnDef="product">
                        <th mat-header-cell *matHeaderCellDef>{{ 'product' | translate }}</th>
                        <td mat-cell *matCellDef="let item">{{ item.productName || item.productCode }}</td>
                      </ng-container>
                      <ng-container matColumnDef="reason">
                        <th mat-header-cell *matHeaderCellDef>{{ 'reason' | translate }}</th>
                        <td mat-cell *matCellDef="let item">
                          <input
                                  matInput
                                  [value]="item.reason || ''"
                                  (blur)="onUpdateReason(item.id!, $any($event.target).value)"
                                  placeholder="{{ 'returnReason' | translate }}">
                        </td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['product', 'reason']"></tr>
                      <tr mat-row *matRowDef="let row; columns: ['product', 'reason'];"></tr>
                    </table>
                  </div>
                </div>
              }

              <!-- Review Sub-step -->
              @if (currentEntrySubStep() === 'review') {
                <div class="sub-step-content">
                  <h3>{{ 'rmaEntry.subStep.review' | translate }}</h3>
                  <div class="review-summary">
                    <p><strong>{{ 'order' | translate }}:</strong> {{ getOrderNumber(rma()?.orderId) }}</p>
                    <p><strong>{{ 'customer' | translate }}:</strong> {{ getCustomerName(rma()?.customerId) }}</p>
                    <p><strong>{{ 'orderItems' | translate }}:</strong> {{ rma()?.items?.length || 0 }}</p>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>{{ 'restockingFee' | translate }}</mat-label>
                      <input matInput type="number" [value]="restockingFee()"
                             (input)="onRestockingFeeChange(+$any($event.target).value)" min="0" step="0.01">
                    </mat-form-field>
                    <p><strong>{{ 'subtotal' | translate }}:</strong> ${{ rma()?.subtotal?.toFixed(2) || '0.00' }}</p>
                    <p><strong>{{ 'restockingFee' | translate }}:</strong>
                      ${{ rma()?.restockingFee?.toFixed(2) || '0.00' }}</p>
                    <p><strong>{{ 'total' | translate }}:</strong> ${{ rma()?.total?.toFixed(2) || '0.00' }}</p>
                  </div>
                </div>
              }
            </div>
          </div>
        }

        <!-- Approval Step -->
        @if (currentStep() === 'approval') {
          <div class="step-content">
            <h3>{{ 'rmaEntry.step.approval' | translate }}</h3>
            <p class="step-description">{{ 'rmaEntry.approval.description' | translate }}</p>

            <div class="approval-checks">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>{{ 'rmaEntry.approval.notes' | translate }}</mat-label>
                <textarea matInput [value]="approvalNotes()" (input)="approvalNotes.set($any($event.target).value)"
                          rows="4"></textarea>
              </mat-form-field>
            </div>
          </div>
        }

        <!-- Received Step -->
        @if (currentStep() === 'received') {
          <div class="step-content">
            <h3>{{ 'rmaEntry.step.received' | translate }}</h3>

            <div class="form-fields">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>{{ 'rmaEntry.received.receivedDate' | translate }}</mat-label>
                <input matInput [matDatepicker]="receivedDatePicker" [value]="receivedDate()"
                       (dateChange)="receivedDate.set($event.value)">
                <mat-datepicker-toggle matIconSuffix [for]="receivedDatePicker"></mat-datepicker-toggle>
                <mat-datepicker #receivedDatePicker></mat-datepicker>
              </mat-form-field>
            </div>
          </div>
        }

        <!-- Processed Step -->
        @if (currentStep() === 'processed') {
          <div class="step-content">
            <h3>{{ 'rmaEntry.step.processed' | translate }}</h3>

            <div class="form-fields">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>{{ 'rmaEntry.processed.processedDate' | translate }}</mat-label>
                <input matInput [matDatepicker]="processedDatePicker" [value]="processedDate()"
                       (dateChange)="processedDate.set($event.value)">
                <mat-datepicker-toggle matIconSuffix [for]="processedDatePicker"></mat-datepicker-toggle>
                <mat-datepicker #processedDatePicker></mat-datepicker>
              </mat-form-field>
            </div>
          </div>
        }

        <!-- History Step -->
        @if (currentStep() === 'history') {
          <div class="step-content">
            <h3>{{ 'rmaEntry.step.history' | translate }}</h3>

            <div class="history-content">
              <div class="history-section">
                <h4>{{ 'rmaEntry.history.addNote' | translate }}</h4>
                <div class="form-fields">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>{{ 'notes' | translate }}</mat-label>
                    <textarea matInput [value]="historyNote()" (input)="historyNote.set($any($event.target).value)"
                              rows="3"></textarea>
                  </mat-form-field>
                  <ax-button
                          variant="raised"
                          color="primary"
                          [label]="'add' | translate"
                          (click)="handleAddHistoryNote()"
                          [disabled]="!historyNote() || submitting()">
                  </ax-button>
                </div>
              </div>

              <div class="history-list">
                <h4>{{ 'rmaEntry.history.history' | translate }}</h4>
                @if (rmaHistory().length > 0) {
                  <div class="history-items">
                    @for (record of rmaHistory(); track record.timestamp) {
                      <div class="history-item">
                        <div class="history-header">
                          <strong>{{ record.stepLabel || record.step }}</strong>
                          <span class="history-date">{{ record.timestamp | date:'short' }}</span>
                        </div>
                        @if (record.notes || record.note) {
                          <p class="history-notes">{{ record.notes || record.note }}</p>
                        }
                        @if (hasDataKeys(record.data)) {
                          <div class="history-data">
                            @for (item of record.data | keyvalue; track item.key) {
                              <div class="data-item">
                                <strong>{{ getDataKeyLabel(toString(item.key)) | translate }}:</strong>
                                {{ formatDataValue(toString(item.key), item.value) }}
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                } @else {
                  <p class="no-history">{{ 'rmaEntry.history.noHistory' | translate }}</p>
                }
              </div>
            </div>
          </div>
        }

        <!-- Navigation Buttons -->
        <div class="navigation-buttons">
          <button
                  mat-button
                  (click)="handlePrevious()"
                  [disabled]="currentStep() === 'entry' && currentEntrySubStep() === 'order'">
            <mat-icon>arrow_back</mat-icon>
            {{ 'previous' | translate }}
          </button>

          <!-- Step-specific action buttons -->
          @if (currentStep() === 'entry' && currentEntrySubStep() === 'review') {
            <ax-button
                    variant="raised"
                    color="primary"
                    [label]="'rmaEntry.completeEntry' | translate"
                    (click)="handleCompleteEntry()"
                    [disabled]="!canProceedToNext() || submitting()">
            </ax-button>
          } @else if (currentStep() === 'approval') {
            <ax-button
                    variant="raised"
                    color="primary"
                    [label]="'rmaEntry.approve' | translate"
                    (click)="handleApproveRMA()"
                    [disabled]="!canProceedToNext() || submitting()">
            </ax-button>
          } @else if (currentStep() === 'received') {
            <ax-button
                    variant="raised"
                    color="primary"
                    [label]="'rmaEntry.receive' | translate"
                    (click)="handleReceiveRMA()"
                    [disabled]="!canProceedToNext() || submitting()">
            </ax-button>
          } @else if (currentStep() === 'processed') {
            <ax-button
                    variant="raised"
                    color="primary"
                    [label]="'rmaEntry.process' | translate"
                    (click)="handleProcessRMA()"
                    [disabled]="!canProceedToNext() || submitting()">
            </ax-button>
          } @else {
            <ax-button
                    variant="raised"
                    color="primary"
                    [label]="'next' | translate"
                    (click)="handleNext()"
                    [disabled]="!canProceedToNext()">
            </ax-button>
          }
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>

