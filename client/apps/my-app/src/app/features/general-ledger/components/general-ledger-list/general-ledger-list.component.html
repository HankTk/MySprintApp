<div class="gl-list-container">
  <mat-card class="main-card">
    <mat-card-header>
      <div class="header-content">
        <button mat-icon-button (click)="goBack()" aria-label="Go back" class="back-button">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <mat-card-title class="card-title">
          <mat-icon class="title-icon">account_balance</mat-icon>
          {{ 'generalLedger.title' | translate }}
        </mat-card-title>
      </div>
    </mat-card-header>

    <mat-card-content>
      <div class="controls-section">
        <div class="filter-section">
          <mat-form-field appearance="outline" class="date-filter">
            <mat-label>{{ 'generalLedger.filter.fromDate' | translate }}</mat-label>
            <input matInput type="date" [value]="dateFrom()" (change)="onDateFromChange($event)">
          </mat-form-field>

          <mat-form-field appearance="outline" class="date-filter">
            <mat-label>{{ 'generalLedger.filter.toDate' | translate }}</mat-label>
            <input matInput type="date" [value]="dateTo()" (change)="onDateToChange($event)">
          </mat-form-field>

          <mat-form-field appearance="outline" class="type-filter">
            <mat-label>{{ 'generalLedger.filter.byType' | translate }}</mat-label>
            <mat-select [value]="typeFilter()" (selectionChange)="onTypeFilterChange($event.value)">
              <mat-option [value]="null">{{ 'generalLedger.filter.allTypes' | translate }}</mat-option>
              <mat-option value="REVENUE">{{ 'generalLedger.type.revenue' | translate }}</mat-option>
              <mat-option value="COST">{{ 'generalLedger.type.cost' | translate }}</mat-option>
              <mat-option value="EXPENSE">{{ 'generalLedger.type.expense' | translate }}</mat-option>
              <mat-option value="ACCOUNTS_PAYABLE">{{ 'generalLedger.type.accountsPayable' | translate }}</mat-option>
              <mat-option value="PAYMENT">{{ 'generalLedger.type.payment' | translate }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <div class="table-container">
        <table mat-table [dataSource]="filteredEntries() || []" class="gl-table">
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef>{{ 'generalLedger.table.date' | translate }}</th>
            <td mat-cell *matCellDef="let entry">{{ formatDate(entry.date) }}</td>
          </ng-container>

          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>{{ 'generalLedger.table.type' | translate }}</th>
            <td mat-cell *matCellDef="let entry">
              <span 
                class="type-badge" 
                [style.color]="getTypeColor(entry.type)"
                [style.background-color]="getTypeBackgroundColor(entry.type)">
                {{ getTypeLabel(entry.type) }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="orderPoInvoice">
            <th mat-header-cell *matHeaderCellDef>{{ 'generalLedger.table.orderPoInvoice' | translate }}</th>
            <td mat-cell *matCellDef="let entry">
              <span *ngIf="entry.poNumber">{{ 'generalLedger.poPrefix' | translate }} {{ entry.poNumber }}</span>
              <span *ngIf="entry.orderNumber">{{ 'generalLedger.orderPrefix' | translate }} {{ entry.orderNumber }}</span>
              <span *ngIf="!entry.poNumber && !entry.orderNumber">-</span>
              <span *ngIf="entry.invoiceNumber"> / {{ entry.invoiceNumber }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="customerSupplier">
            <th mat-header-cell *matHeaderCellDef>{{ 'generalLedger.table.customerSupplier' | translate }}</th>
            <td mat-cell *matCellDef="let entry">{{ entry.customerName || entry.supplierName || '-' }}</td>
          </ng-container>

          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>{{ 'generalLedger.table.description' | translate }}</th>
            <td mat-cell *matCellDef="let entry">{{ entry.description }}</td>
          </ng-container>

          <ng-container matColumnDef="quantity">
            <th mat-header-cell *matHeaderCellDef class="text-right">{{ 'generalLedger.table.quantity' | translate }}</th>
            <td mat-cell *matCellDef="let entry" class="text-right">{{ entry.quantity }}</td>
          </ng-container>

          <ng-container matColumnDef="debit">
            <th mat-header-cell *matHeaderCellDef class="text-right">{{ 'generalLedger.table.debit' | translate }}</th>
            <td mat-cell *matCellDef="let entry" class="text-right">
              <span [class.debit-amount]="getDebitAmount(entry) > 0">
                {{ getDebitAmount(entry) > 0 ? (getDebitAmount(entry) | currency) : '-' }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="credit">
            <th mat-header-cell *matHeaderCellDef class="text-right">{{ 'generalLedger.table.credit' | translate }}</th>
            <td mat-cell *matCellDef="let entry" class="text-right">
              <span [class.credit-amount]="getCreditAmount(entry) > 0">
                {{ getCreditAmount(entry) > 0 ? (getCreditAmount(entry) | currency) : '-' }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="text-center">{{ 'generalLedger.table.actions' | translate }}</th>
            <td mat-cell *matCellDef="let entry" class="text-center">
              <button 
                *ngIf="entry.orderId || entry.poId"
                mat-icon-button 
                color="primary" 
                (click)="viewEntry(entry)" 
                [matTooltip]="'generalLedger.table.view' | translate">
                <mat-icon>visibility</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns()"></tr>
        </table>

        @if (filteredEntries() && filteredEntries().length === 0 && !isLoading()) {
          <div class="no-data">
            <mat-icon class="no-data-icon">info</mat-icon>
            <p>{{ 'generalLedger.noEntries' | translate }}</p>
          </div>
        }

        @if (isLoading()) {
          <div class="loading">
            <mat-spinner diameter="40"></mat-spinner>
            <p>{{ 'generalLedger.loading' | translate }}</p>
          </div>
        }
      </div>

      @if (filteredEntries() && filteredEntries().length > 0) {
        <div class="summary-section">
          <div class="summary-item">
            <span class="summary-label">{{ 'generalLedger.summary.totalDebit' | translate }}</span>
            <span class="summary-value debit">{{ totalDebit | currency }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">{{ 'generalLedger.summary.totalCredit' | translate }}</span>
            <span class="summary-value credit">{{ totalCredit | currency }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">{{ 'generalLedger.summary.totalRevenue' | translate }}</span>
            <span class="summary-value credit">{{ totalRevenue | currency }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">{{ 'generalLedger.summary.totalCost' | translate }}</span>
            <span class="summary-value debit">{{ totalCost | currency }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">{{ 'generalLedger.summary.totalExpense' | translate }}</span>
            <span class="summary-value debit">{{ totalExpense | currency }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">{{ 'generalLedger.summary.totalAccountsPayable' | translate }}</span>
            <span class="summary-value debit">{{ totalAccountsPayable | currency }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">{{ 'generalLedger.summary.totalPayments' | translate }}</span>
            <span class="summary-value credit">{{ totalPayment | currency }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">{{ 'generalLedger.summary.netIncome' | translate }}</span>
            <span class="summary-value" [class.debit]="netIncome < 0" [class.credit]="netIncome >= 0">
              {{ netIncome | currency }}
            </span>
          </div>
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>

