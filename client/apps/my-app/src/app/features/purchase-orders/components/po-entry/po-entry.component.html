<div class="po-entry-container">
  <mat-card class="main-card">
    <mat-card-header>
      <div class="header-content">
        <button mat-icon-button (click)="goBack()" aria-label="Go back" class="back-button">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <mat-card-title class="card-title">
          <mat-icon class="title-icon">receipt</mat-icon>
          {{ 'purchaseOrderEntry.title' | translate }}
        </mat-card-title>
      </div>
    </mat-card-header>

    <mat-card-content>
      @if (loading()) {
        <div class="loading-container">
          <mat-spinner diameter="50"></mat-spinner>
        </div>
      } @else {
        <!-- Step Indicator -->
        <div class="step-indicator">
          <div class="step-list">
            @for (step of steps; track step.key) {
              <div 
                class="step-item"
                [class.active]="currentStep() === step.key"
                [class.completed]="isStepCompleted(step.key)"
                [class.clickable]="isStepCompleted(step.key) || currentStep() === step.key"
                (click)="onStepClick(step.key)">
                <div class="step-number">{{ $index + 1 }}</div>
                <div class="step-label">{{ step.label | translate }}</div>
              </div>
            }
          </div>
        </div>

        <!-- Entry Step with Sub-steps -->
        @if (currentStep() === 'entry') {
          <div class="entry-sub-steps">
            <div class="sub-step-indicator">
              @for (subStep of entrySubSteps; track subStep.key) {
                <button
                  mat-button
                  class="sub-step-button"
                  [class.active]="currentEntrySubStep() === subStep.key"
                  [class.completed]="isSubStepCompleted(subStep.key)"
                  (click)="currentEntrySubStep.set(subStep.key)">
                  {{ subStep.label | translate }}
                </button>
              }
            </div>

            <div class="step-content">
              <!-- Supplier Sub-step -->
              @if (currentEntrySubStep() === 'supplier') {
                <div class="sub-step-content">
                  <h3>{{ 'purchaseOrderEntry.subStep.supplier' | translate }}</h3>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>{{ 'supplier' | translate }}</mat-label>
                    <mat-select [value]="po()?.supplierId || null" (selectionChange)="onSupplierChange($event.value)">
                      <mat-option [value]="null">{{ 'selectSupplier' | translate }}</mat-option>
                      @for (vendor of vendors(); track vendor.id) {
                        <mat-option [value]="vendor.id">
                          {{ vendor.companyName || (vendor.firstName + ' ' + vendor.lastName) }}
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>
              }

              <!-- Products Sub-step -->
              @if (currentEntrySubStep() === 'products') {
                <div class="sub-step-content">
                  <h3>{{ 'purchaseOrderEntry.subStep.products' | translate }}</h3>
                  
                  <div class="product-selection">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>{{ 'product' | translate }}</mat-label>
                      <mat-select [value]="selectedProduct()" (selectionChange)="selectedProduct.set($event.value)">
                        <mat-option [value]="null">{{ 'selectProduct' | translate }}</mat-option>
                        @for (product of products(); track product.id) {
                          <mat-option [value]="product.id">
                            {{ product.productName || product.productCode }} - ${{ product.unitPrice?.toFixed(2) || '0.00' }}
                          </mat-option>
                        }
                      </mat-select>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field quantity-field">
                      <mat-label>{{ 'quantity' | translate }}</mat-label>
                      <input matInput type="number" [value]="quantity()" (input)="quantity.set(+$any($event.target).value)" min="1" step="1">
                    </mat-form-field>

                    <button
                      mat-raised-button
                      color="primary"
                      (click)="onAddProduct()"
                      [disabled]="!selectedProduct() || loading()"
                      class="add-product-button">
                      <mat-icon>add</mat-icon>
                      {{ 'add' | translate }}
                    </button>
                  </div>

                  <div class="items-table-container">
                    <table mat-table [dataSource]="po()?.items || []" class="items-table">
                      <ng-container matColumnDef="product">
                        <th mat-header-cell *matHeaderCellDef>{{ 'product' | translate }}</th>
                        <td mat-cell *matCellDef="let item">{{ item.productName || item.productCode }}</td>
                      </ng-container>

                      <ng-container matColumnDef="quantity">
                        <th mat-header-cell *matHeaderCellDef>{{ 'quantity' | translate }}</th>
                        <td mat-cell *matCellDef="let item">
                          <div class="quantity-controls">
                            <button
                              mat-icon-button
                              (click)="onUpdateQuantity(item.id!, (item.quantity || 1) - 1)"
                              [disabled]="loading() || (item.quantity || 1) <= 1"
                              class="quantity-button">
                              <mat-icon>remove</mat-icon>
                            </button>
                            <span class="quantity-value">{{ item.quantity || 0 }}</span>
                            <button
                              mat-icon-button
                              (click)="onUpdateQuantity(item.id!, (item.quantity || 1) + 1)"
                              [disabled]="loading()"
                              class="quantity-button">
                              <mat-icon>add</mat-icon>
                            </button>
                          </div>
                        </td>
                      </ng-container>

                      <ng-container matColumnDef="unitPrice">
                        <th mat-header-cell *matHeaderCellDef class="text-right">{{ 'unitPrice' | translate }}</th>
                        <td mat-cell *matCellDef="let item" class="text-right">${{ item.unitPrice?.toFixed(2) || '0.00' }}</td>
                      </ng-container>

                      <ng-container matColumnDef="lineTotal">
                        <th mat-header-cell *matHeaderCellDef class="text-right">{{ 'lineTotal' | translate }}</th>
                        <td mat-cell *matCellDef="let item" class="text-right">${{ item.lineTotal?.toFixed(2) || '0.00' }}</td>
                      </ng-container>

                      <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef class="text-center">{{ 'actions' | translate }}</th>
                        <td mat-cell *matCellDef="let item" class="text-center">
                          <button
                            mat-icon-button
                            color="warn"
                            (click)="onRemoveItem(item.id!)"
                            [disabled]="loading()"
                            class="remove-button">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </td>
                      </ng-container>

                      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                    </table>

                    @if (!po()?.items || po()?.items?.length === 0) {
                      <div class="no-items">
                        <p>{{ 'noOrderItems' | translate }}</p>
                      </div>
                    }
                  </div>
                </div>
              }

              <!-- Shipping Sub-step -->
              @if (currentEntrySubStep() === 'shipping') {
                <div class="sub-step-content">
                  <h3>{{ 'purchaseOrderEntry.subStep.shipping' | translate }}</h3>
                  
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>{{ 'shippingAddress' | translate }}</mat-label>
                      <mat-select [value]="po()?.shippingAddressId || null" (selectionChange)="onShippingInfoChange($event.value || '', po()?.billingAddressId || '')">
                        <mat-option [value]="null">{{ 'selectAddress' | translate }}</mat-option>
                        @for (address of addresses(); track address.id) {
                          <mat-option [value]="address.id">
                            {{ address.streetAddress1 }}, {{ address.city }}, {{ address.state }} {{ address.postalCode }}
                          </mat-option>
                        }
                      </mat-select>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>{{ 'billingAddress' | translate }}</mat-label>
                      <mat-select [value]="po()?.billingAddressId || null" (selectionChange)="onShippingInfoChange(po()?.shippingAddressId || '', $event.value || '')">
                        <mat-option [value]="null">{{ 'selectAddress' | translate }}</mat-option>
                        @for (address of addresses(); track address.id) {
                          <mat-option [value]="address.id">
                            {{ address.streetAddress1 }}, {{ address.city }}, {{ address.state }} {{ address.postalCode }}
                          </mat-option>
                        }
                      </mat-select>
                    </mat-form-field>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>{{ 'expectedDeliveryDate' | translate }}</mat-label>
                    <input matInput [matDatepicker]="expectedDeliveryDatePicker" [value]="expectedDeliveryDate()" (dateChange)="onExpectedDeliveryDateChange($event.value)">
                    <mat-datepicker-toggle matIconSuffix [for]="expectedDeliveryDatePicker"></mat-datepicker-toggle>
                    <mat-datepicker #expectedDeliveryDatePicker></mat-datepicker>
                  </mat-form-field>
                </div>
              }

              <!-- Review Sub-step -->
              @if (currentEntrySubStep() === 'review') {
                <div class="sub-step-content">
                  <h3>{{ 'purchaseOrderEntry.subStep.review' | translate }}</h3>
                  <div class="review-summary">
                    <p><strong>{{ 'supplier' | translate }}:</strong> {{ getVendorName(po()?.supplierId) }}</p>
                    <p><strong>{{ 'orderItems' | translate }}:</strong> {{ po()?.items?.length || 0 }}</p>
                    <p><strong>{{ 'subtotal' | translate }}:</strong> ${{ po()?.subtotal?.toFixed(2) || '0.00' }}</p>
                    <p><strong>{{ 'total' | translate }}:</strong> ${{ po()?.total?.toFixed(2) || '0.00' }}</p>
                  </div>
                </div>
              }
            </div>
          </div>
        }

        <!-- Approval Step -->
        @if (currentStep() === 'approval') {
          <div class="step-content">
            <h3>{{ 'purchaseOrderEntry.step.approval' | translate }}</h3>
            <p class="step-description">{{ 'purchaseOrderEntry.approval.description' | translate }}</p>
            
            <div class="approval-checks">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>{{ 'purchaseOrderEntry.approval.notes' | translate }}</mat-label>
                <textarea matInput [value]="approvalNotes()" (input)="approvalNotes.set($any($event.target).value)" rows="4"></textarea>
              </mat-form-field>
            </div>
          </div>
        }

        <!-- Received Step -->
        @if (currentStep() === 'received') {
          <div class="step-content">
            <h3>{{ 'purchaseOrderEntry.step.received' | translate }}</h3>
            
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'purchaseOrderEntry.received.receivedDate' | translate }}</mat-label>
              <input matInput [matDatepicker]="receivedDatePicker" [value]="receivedDate()" (dateChange)="receivedDate.set($event.value)">
              <mat-datepicker-toggle matIconSuffix [for]="receivedDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #receivedDatePicker></mat-datepicker>
            </mat-form-field>
          </div>
        }

        <!-- Invoicing Step -->
        @if (currentStep() === 'invoicing') {
          <div class="step-content">
            <h3>{{ 'purchaseOrderEntry.step.invoicing' | translate }}</h3>
            
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>{{ 'invoiceNumber' | translate }}</mat-label>
                <input matInput [value]="invoiceNumber()" (input)="invoiceNumber.set($any($event.target).value)">
                <button mat-icon-button matSuffix (click)="loadInvoiceNumber()" [disabled]="loading()">
                  <mat-icon>refresh</mat-icon>
                </button>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>{{ 'invoiceDate' | translate }}</mat-label>
                <input matInput [matDatepicker]="invoiceDatePicker" [value]="invoiceDate()" (dateChange)="invoiceDate.set($event.value)">
                <mat-datepicker-toggle matIconSuffix [for]="invoiceDatePicker"></mat-datepicker-toggle>
                <mat-datepicker #invoiceDatePicker></mat-datepicker>
              </mat-form-field>
            </div>
          </div>
        }

        <!-- History Step -->
        @if (currentStep() === 'history') {
          <div class="step-content">
            <h3>{{ 'purchaseOrderEntry.step.history' | translate }}</h3>
            
            <div class="history-section">
              <h4>{{ 'purchaseOrderEntry.history.addNote' | translate }}</h4>
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>{{ 'notes' | translate }}</mat-label>
                <textarea matInput [value]="historyNote()" (input)="historyNote.set($any($event.target).value)" rows="3"></textarea>
              </mat-form-field>
              <button
                mat-raised-button
                color="primary"
                (click)="handleAddHistoryNote()"
                [disabled]="!historyNote() || submitting()">
                {{ 'add' | translate }}
              </button>
            </div>

            <div class="history-list">
              <h4>{{ 'purchaseOrderEntry.history.history' | translate }}</h4>
              @if (poHistory().length > 0) {
                @for (record of poHistory(); track record.timestamp) {
                  <div class="history-item">
                    <div class="history-header">
                      <strong>{{ record.stepLabel || record.step }}</strong>
                      <span class="history-date">{{ record.timestamp | date:'short' }}</span>
                    </div>
                    @if (record.notes || record.note) {
                      <p class="history-notes">{{ record.notes || record.note }}</p>
                    }
                    @if (hasDataKeys(record.data)) {
                      <div class="history-data">
                        @for (item of record.data | keyvalue; track item.key) {
                          <div class="data-item">
                            <strong>{{ getDataKeyLabel(toString(item.key)) | translate }}:</strong> 
                            {{ formatDataValue(toString(item.key), item.value) }}
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              } @else {
                <p>{{ 'purchaseOrderEntry.history.noHistory' | translate }}</p>
              }
            </div>
          </div>
        }

        <!-- Navigation Buttons -->
        <div class="navigation-buttons">
          <button
            mat-button
            (click)="handlePrevious()"
            [disabled]="currentStep() === 'entry' && currentEntrySubStep() === 'supplier'">
            <mat-icon>arrow_back</mat-icon>
            {{ 'previous' | translate }}
          </button>
          
          <!-- Step-specific action buttons -->
          @if (currentStep() === 'entry' && currentEntrySubStep() === 'review') {
            <button
              mat-raised-button
              color="primary"
              (click)="handleCompleteEntry()"
              [disabled]="!canProceedToNext() || submitting()">
              {{ 'purchaseOrderEntry.completeEntry' | translate }}
            </button>
          } @else if (currentStep() === 'approval') {
            <button
              mat-raised-button
              color="primary"
              (click)="handleApprovePO()"
              [disabled]="!canProceedToNext() || submitting()">
              {{ 'purchaseOrderEntry.approve' | translate }}
            </button>
          } @else if (currentStep() === 'received') {
            <button
              mat-raised-button
              color="primary"
              (click)="handleReceivePO()"
              [disabled]="!canProceedToNext() || submitting()">
              {{ 'purchaseOrderEntry.receive' | translate }}
            </button>
          } @else if (currentStep() === 'invoicing') {
            <button
              mat-raised-button
              color="primary"
              (click)="handleInvoicePO()"
              [disabled]="!canProceedToNext() || submitting()">
              {{ 'purchaseOrderEntry.invoice' | translate }}
            </button>
          } @else {
            <button
              mat-raised-button
              color="primary"
              (click)="handleNext()"
              [disabled]="!canProceedToNext()">
              {{ 'next' | translate }}
              <mat-icon>arrow_forward</mat-icon>
            </button>
          }
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>

