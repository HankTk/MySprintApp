@if (passThrough) {
  <div class="ax-table-container">
    <ng-content></ng-content>
  </div>
} @else {
  <div class="ax-table-container">
    <table mat-table [dataSource]="paginatedData" class="ax-table" matSort (matSortChange)="onSortChange($event)">
      <!-- Selection column -->
      @if (selectionMode !== 'none') {
        <ng-container matColumnDef="_select">
          <th mat-header-cell *matHeaderCellDef class="selection-header">
            @if (selectionMode === 'multiple') {
              <mat-checkbox
                [checked]="isAllSelected()"
                [indeterminate]="selection.selected.length > 0 && !isAllSelected()"
                (change)="$event ? masterToggle() : null">
              </mat-checkbox>
            }
          </th>
          <td mat-cell *matCellDef="let row" class="selection-cell">
            @if (selectionMode === 'multiple') {
              <mat-checkbox
                [checked]="isSelected(row)"
                (change)="$event ? toggleRow(row) : null">
              </mat-checkbox>
            } @else if (selectionMode === 'single') {
              <mat-checkbox
                [checked]="isSelected(row)"
                (change)="$event ? toggleRow(row) : null">
              </mat-checkbox>
            }
          </td>
        </ng-container>
      }
      

      <!-- Filter columns (always render if filtering is enabled, visibility controlled by CSS) -->
      @if (filterable) {
        @for (column of computedColumns; track column.key) {
          <ng-container [matColumnDef]="column.key + '_filter'">
            <th mat-header-cell *matHeaderCellDef class="filter-header" [style.width]="column.width" [attr.data-column-key]="column.key">
              @if (column.filterable) {
                @if (column.filterType === 'date-range') {
                  <div class="date-range-single-wrapper" [attr.data-column-key]="column.key" (click)="$event.stopPropagation()">
                    <mat-form-field appearance="outline" class="filter-field-inline date-range-single">
                      <input
                        matInput
                        [value]="getDateRangeDisplay(column.key)"
                        placeholder="Date Range"
                        readonly
                        (click)="toggleDateRangePicker(column.key)">
                      <button
                        matIconSuffix
                        mat-icon-button
                        type="button"
                        (click)="toggleDateRangePicker(column.key); $event.stopPropagation()"
                        aria-label="Open date range picker">
                        <mat-icon>calendar_today</mat-icon>
                      </button>
                    </mat-form-field>
                    
                  </div>
                } @else if (column.filterType === 'select') {
                  <ax-select
                    class="filter-field-inline"
                    [options]="getFilterOptions(column)"
                    [value]="getFilterValue(column.key)"
                    (selectionChange)="onFilterChange(column.key, $event)">
                  </ax-select>
                } @else if (column.filterType === 'autocomplete') {
                  <mat-form-field appearance="outline" class="filter-field-inline">
                    <input
                      matInput
                      [matAutocomplete]="auto"
                      [placeholder]="'Filter ' + column.header"
                      [(ngModel)]="columnFilters[column.key]"
                      (ngModelChange)="onFilterChange(column.key, $event)">
                    <mat-autocomplete #auto="matAutocomplete" [displayWith]="getFilterDisplayFn(column)">
                      @for (option of getFilterOptions(column); track option.value) {
                        <mat-option [value]="option.value">{{ option.label }}</mat-option>
                      }
                    </mat-autocomplete>
                  </mat-form-field>
                } @else {
                  <mat-form-field appearance="outline" class="filter-field-inline">
                    <input
                      matInput
                      [placeholder]="'Filter ' + column.header"
                      [(ngModel)]="columnFilters[column.key]"
                      (ngModelChange)="onFilterChange(column.key, $event)">
                  </mat-form-field>
                }
              }
            </th>
            <td mat-cell *matCellDef="let row"></td>
          </ng-container>
        }
      }

      <!-- Data columns -->
      @for (column of computedColumns; track column.key) {
        <ng-container [matColumnDef]="column.key">
          <th 
            mat-header-cell 
            *matHeaderCellDef 
            [mat-sort-header]="showSort && column.sortable ? column.key : ''"
            [style.width]="column.width"
            [style.text-align]="column.align">
            @if (column.headerTemplate) {
              <ng-container *ngTemplateOutlet="column.headerTemplate; context: { $implicit: column }"></ng-container>
            } @else if (headerTemplate) {
              <ng-container *ngTemplateOutlet="headerTemplate; context: { $implicit: column }"></ng-container>
            } @else {
              {{ column.header }}
            }
          </th>
          <td 
            mat-cell 
            *matCellDef="let row"
            [style.text-align]="column.align">
            @if (column.cellTemplate) {
              <ng-container *ngTemplateOutlet="column.cellTemplate; context: { $implicit: row, column: column }"></ng-container>
            } @else if (rowTemplate) {
              <ng-container *ngTemplateOutlet="rowTemplate; context: { $implicit: row, column: column }"></ng-container>
            } @else {
              @if (column.formatter) {
                {{ column.formatter(getCellValue(row, column), row) }}
              } @else {
                {{ getCellValue(row, column) }}
              }
            }
          </td>
        </ng-container>
      }

      <!-- Filter row (if filtering is enabled and showFilter is true) -->
      <tr mat-header-row *matHeaderRowDef="allColumnKeys"></tr>
      @if (filterable) {
        <tr 
          mat-header-row 
          *matHeaderRowDef="getFilterRowColumns()" 
          class="filter-row"
          [class.filter-row-hidden]="!showFilter">
        </tr>
      }
      <tr 
        mat-row 
        *matRowDef="let row; columns: allColumnKeys"
        [class.selected-row]="isSelected(row)"
        (click)="selectionMode !== 'none' ? toggleRow(row) : null"
        [class.selectable-row]="selectionMode !== 'none'">
      </tr>
    </table>

    @if (showPaginator) {
      <mat-paginator
        [length]="totalFilteredCount"
        [pageSize]="currentPageSize"
        [pageSizeOptions]="pageSizeOptions"
        [pageIndex]="currentPage"
        (page)="onPageChange($event)">
      </mat-paginator>
    }
  </div>
}

<!-- Template for date range picker overlay -->
<ng-template #dateRangePopupTemplate let-columnKey="columnKey">
  <div class="date-range-popup">
    <div class="date-range-popup-content">
      <p style="margin: 0 0 12px 0; font-weight: 500; color: #333;">Select Date Range</p>
      <div class="date-range-fields" style="display: flex !important; gap: 8px; margin-bottom: 16px; visibility: visible !important;">
        <mat-form-field appearance="outline" style="flex: 1; display: block !important; visibility: visible !important;">
          <mat-label>From</mat-label>
          <input
            matInput
            [matDatepicker]="startPicker"
            [value]="getTempStartDate(columnKey)"
            (dateChange)="onDateRangeStartChange(columnKey, $event, getTempEndDate(columnKey))"
            placeholder="Start date"
            style="visibility: visible !important; display: block !important;">
          <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>
        <span style="padding: 0 4px; margin-top: 24px; color: rgba(0, 0, 0, 0.6); display: inline-block;">-</span>
        <mat-form-field appearance="outline" style="flex: 1; display: block !important; visibility: visible !important;">
          <mat-label>To</mat-label>
          <input
            matInput
            [matDatepicker]="endPicker"
            [value]="getTempEndDate(columnKey)"
            (dateChange)="onDateRangeEndChange(columnKey, getTempStartDate(columnKey), $event)"
            placeholder="End date"
            style="visibility: visible !important; display: block !important;">
          <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>
      </div>
      <div class="date-range-actions">
        <button mat-button (click)="clearDateRange(columnKey); $event.stopPropagation()">Clear</button>
        <button mat-button color="primary" (click)="closeDateRangePicker(columnKey); $event.stopPropagation()">Apply</button>
      </div>
    </div>
  </div>
</ng-template>
