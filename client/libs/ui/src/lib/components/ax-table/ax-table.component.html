@if (passThrough) {
  <div class="ax-table-container">
    <ng-content></ng-content>
  </div>
} @else {
  <div class="ax-table-container">
    <table mat-table [dataSource]="paginatedData" class="ax-table" matSort (matSortChange)="onSortChange($event)">
      <!-- Selection column -->
      @if (selectionMode !== 'none') {
        <ng-container matColumnDef="_select">
          <th mat-header-cell *matHeaderCellDef class="selection-header">
            @if (selectionMode === 'multiple') {
              <mat-checkbox
                [checked]="isAllSelected()"
                [indeterminate]="selection.selected.length > 0 && !isAllSelected()"
                (change)="$event ? masterToggle() : null">
              </mat-checkbox>
            }
          </th>
          <td mat-cell *matCellDef="let row" class="selection-cell">
            @if (selectionMode === 'multiple') {
              <mat-checkbox
                [checked]="isSelected(row)"
                (change)="$event ? toggleRow(row) : null">
              </mat-checkbox>
            } @else if (selectionMode === 'single') {
              <mat-checkbox
                [checked]="isSelected(row)"
                (change)="$event ? toggleRow(row) : null">
              </mat-checkbox>
            }
          </td>
        </ng-container>
      }
      

      <!-- Filter columns (if filtering is enabled) -->
      @if (showFilter) {
        @for (column of computedColumns; track column.key) {
          <ng-container [matColumnDef]="column.key + '_filter'">
            <th mat-header-cell *matHeaderCellDef class="filter-header" [style.width]="column.width">
              @if (column.filterable) {
                @if (column.filterType === 'date-range') {
                  <div class="date-range-single-wrapper" (click)="$event.stopPropagation()">
                    <mat-form-field appearance="outline" class="filter-field-inline date-range-single">
                      <input
                        matInput
                        [value]="getDateRangeDisplay(column.key)"
                        placeholder="Date Range"
                        readonly
                        (click)="toggleDateRangePicker(column.key)">
                      <button
                        matIconSuffix
                        mat-icon-button
                        type="button"
                        (click)="toggleDateRangePicker(column.key); $event.stopPropagation()"
                        aria-label="Open date range picker">
                        <mat-icon>calendar_today</mat-icon>
                      </button>
                    </mat-form-field>
                    
                    @if (openDateRangePicker[column.key]) {
                      <div class="date-range-popup">
                        <div class="date-range-popup-content">
                          <ax-date-range-picker
                            [startDate]="dateRangeFilters[column.key]?.start"
                            [endDate]="dateRangeFilters[column.key]?.end"
                            (startDateChange)="onDateRangeStartDateChange(column.key, $event)"
                            (endDateChange)="onDateRangeEndDateChange(column.key, $event)">
                          </ax-date-range-picker>
                          <div class="date-range-actions">
                            <button mat-button (click)="clearDateRange(column.key); $event.stopPropagation()">Clear</button>
                            <button mat-button color="primary" (click)="closeDateRangePicker(column.key); $event.stopPropagation()">Apply</button>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                } @else if (column.filterType === 'select') {
                  <ax-select
                    class="filter-field-inline"
                    [options]="getFilterOptions(column)"
                    [value]="getFilterValue(column.key)"
                    (selectionChange)="onFilterChange(column.key, $event)">
                  </ax-select>
                } @else if (column.filterType === 'autocomplete') {
                  <mat-form-field appearance="outline" class="filter-field-inline">
                    <input
                      matInput
                      [matAutocomplete]="auto"
                      [placeholder]="'Filter ' + column.header"
                      [(ngModel)]="columnFilters[column.key]"
                      (ngModelChange)="onFilterChange(column.key, $event)">
                    <mat-autocomplete #auto="matAutocomplete" [displayWith]="getFilterDisplayFn(column)">
                      @for (option of getFilterOptions(column); track option.value) {
                        <mat-option [value]="option.value">{{ option.label }}</mat-option>
                      }
                    </mat-autocomplete>
                  </mat-form-field>
                } @else {
                  <mat-form-field appearance="outline" class="filter-field-inline">
                    <input
                      matInput
                      [placeholder]="'Filter ' + column.header"
                      [(ngModel)]="columnFilters[column.key]"
                      (ngModelChange)="onFilterChange(column.key, $event)">
                  </mat-form-field>
                }
              }
            </th>
            <td mat-cell *matCellDef="let row"></td>
          </ng-container>
        }
      }

      <!-- Data columns -->
      @for (column of computedColumns; track column.key) {
        <ng-container [matColumnDef]="column.key">
          <th 
            mat-header-cell 
            *matHeaderCellDef 
            [mat-sort-header]="showSort && column.sortable ? column.key : ''"
            [style.width]="column.width"
            [style.text-align]="column.align">
            @if (column.headerTemplate) {
              <ng-container *ngTemplateOutlet="column.headerTemplate; context: { $implicit: column }"></ng-container>
            } @else if (headerTemplate) {
              <ng-container *ngTemplateOutlet="headerTemplate; context: { $implicit: column }"></ng-container>
            } @else {
              {{ column.header }}
            }
          </th>
          <td 
            mat-cell 
            *matCellDef="let row"
            [style.text-align]="column.align">
            @if (column.cellTemplate) {
              <ng-container *ngTemplateOutlet="column.cellTemplate; context: { $implicit: row, column: column }"></ng-container>
            } @else if (rowTemplate) {
              <ng-container *ngTemplateOutlet="rowTemplate; context: { $implicit: row, column: column }"></ng-container>
            } @else {
              @if (column.formatter) {
                {{ column.formatter(getCellValue(row, column), row) }}
              } @else {
                {{ getCellValue(row, column) }}
              }
            }
          </td>
        </ng-container>
      }

      <!-- Filter row (if filtering is enabled) -->
      @if (showFilter) {
        <tr mat-header-row *matHeaderRowDef="getFilterRowColumns()" class="filter-row"></tr>
      }
      <tr mat-header-row *matHeaderRowDef="allColumnKeys"></tr>
      <tr 
        mat-row 
        *matRowDef="let row; columns: allColumnKeys"
        [class.selected-row]="isSelected(row)"
        (click)="selectionMode !== 'none' ? toggleRow(row) : null"
        [class.selectable-row]="selectionMode !== 'none'">
      </tr>
    </table>

    @if (showPaginator) {
      <mat-paginator
        [length]="totalFilteredCount"
        [pageSize]="currentPageSize"
        [pageSizeOptions]="pageSizeOptions"
        [pageIndex]="currentPage"
        (page)="onPageChange($event)">
      </mat-paginator>
    }
  </div>
}
